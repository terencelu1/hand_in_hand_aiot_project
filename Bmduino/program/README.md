# BMduino 整合程式說明

## 檔案說明

- **BMduino_Integrated.ino** - 主程式，整合所有感測器和功能

## 系統模式

### 1. 待機模式 (STANDBY)
- **功能**：持續感測 GY906、指紋辨識器、心律血氧模組
- **輸出格式**：`STANDBY,物體溫度,環境溫度,心率,血氧`
- **回報頻率**：每 1 秒一次
- **說明**：系統預設模式，持續監控所有感測器

### 2. 工作模式 (WORKING)
- **觸發條件**：檢測到指紋辨識成功
- **功能**：
  - 心律血氧模組開始測量
  - GY906 繼續感測
  - 等待數據穩定（3秒）
  - 回報穩定後的數據
- **輸出格式**：`WORKING,物體溫度,環境溫度,心率,血氧`
- **超時處理**：
  - 15秒內沒有有效數據 → `WORKING,NO_DATA`
  - 沒有手指 → `WORKING,NO_FINGER`
  - 超時 → `WORKING,TIMEOUT`
- **完成後**：自動回到待機模式

### 3. 接收模式 (RECEIVE)
- **觸發條件**：在待機模式下接收到命令
- **功能**：處理繼電器控制命令
- **命令格式**：`RELAY,1` 到 `RELAY,4`
- **回應格式**：
  - 成功：`RELAY_OK,1`
  - 錯誤：`RELAY_ERROR,INVALID_NUMBER` 或 `RELAY_ERROR,INVALID_COMMAND`
- **完成後**：自動回到待機模式，輸出 `MODE,STANDBY`

## 通訊協議

### 輸出格式

#### 待機模式輸出
```
STANDBY,25.50,23.20,72,98
```
格式：`模式,物體溫度,環境溫度,心率,血氧`

#### 工作模式輸出
```
WORKING,START          // 進入工作模式
WORKING,25.50,23.20,72,98  // 數據穩定後輸出
WORKING,NO_FINGER      // 沒有手指
WORKING,NO_DATA        // 15秒內沒有有效數據
WORKING,TIMEOUT        // 超時
```

#### 接收模式輸出
```
MODE,RECEIVE           // 進入接收模式
RELAY_OK,1             // 繼電器控制成功
MODE,STANDBY           // 回到待機模式
```

### 輸入格式

#### 繼電器控制命令
```
RELAY,1    // 控制繼電器 1
RELAY,2    // 控制繼電器 2
RELAY,3    // 控制繼電器 3
RELAY,4    // 控制繼電器 4
```

## 使用步驟

### 1. 上傳程式
1. 打開 Arduino IDE
2. 打開 `BMduino_Integrated.ino`
3. 確認所有必要的庫已安裝：
   - Adafruit Fingerprint Sensor Library
4. 選擇正確的開發板（BMduino-UNO）
5. 上傳程式

### 2. 連接 Native USB
1. 將 BMduino 的 Native USB 連接到 PC/樹莓派
2. 打開串口監視器（115200 波特率）

### 3. 測試模式

#### 測試待機模式
- 系統啟動後自動進入待機模式
- 觀察每 1 秒的數據輸出

#### 測試工作模式
- 將手指放在指紋辨識器上
- 系統自動進入工作模式
- 將手指放在 MAX30102 上測量
- 等待數據穩定後會輸出結果

#### 測試接收模式
- 在串口監視器中輸入：`RELAY,1`
- 觀察繼電器動作和回應

## 腳位連接

- **AS608 指紋辨識**：TX=>D2, RX=>D3
- **4 Relay Module**：IN1=>D8, IN2=>D9, IN3=>D10, IN4=>D11
- **MAX30102**：SDA=>SDA1(D20), SCL=>SCL1(D21)
- **GY-906**：SDA=>SDA(D18), SCL=>SCL(D19)

## 注意事項

1. **數據穩定時間**：工作模式中，數據需要穩定 3 秒才會輸出
2. **超時時間**：工作模式最多持續 15 秒
3. **繼電器動作**：每個繼電器開啟 1 秒後自動關閉
4. **模式切換**：所有模式完成後都會自動回到待機模式
5. **Native USB**：使用 SerialUSB 進行通訊，波特率 115200

## 故障排除

### 問題：看不到數據輸出
- 檢查 Native USB 連接
- 確認 COM 埠和波特率設定正確
- 檢查感測器連接

### 問題：指紋辨識無法觸發工作模式
- 確認指紋已註冊
- 檢查指紋辨識器連接
- 確認指紋辨識器初始化成功

### 問題：工作模式沒有數據
- 確認手指正確放在 MAX30102 上
- 等待數據穩定（3秒）
- 檢查 MAX30102 連接

### 問題：繼電器不動作
- 檢查繼電器連接
- 確認命令格式正確（RELAY,1 到 RELAY,4）
- 檢查電源連接

